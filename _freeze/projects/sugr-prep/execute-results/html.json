{
  "hash": "58db8f94e3abbbc37787a7f4085cb9cb",
  "result": {
    "markdown": "---\ntitle: \"sugr\"\nsubtitle: \"Preparation of Continouos Glucose Measurements for usage in a shiny app\"\nauthor: \"Tobias\"\ndate: \"08. Feb, 2023\"\n---\n\n\n::: tldr\n**tl;dr:** CGMs are a great source of (timeseries) data to tinker with. Here I describe the process of cleaning up and preparing the data of Medtronics systems in order to use it in a shiny app.\n:::\n\n\n\n\n\n# Abstract\n\nI'm a type I diabetic and therefore use an insulin pump and a connected CGM - continouos glucose measurement - system from Medtronic. The company kindly provides access to the raw data, even though only by the use of propriatory software and a web interface. This means I can't access the data through some sort of API to automate the collection thereof and have to run through that process manually on a regular basis.\n\nApart from that minor nuisance what's more important though is the fact that the data needs some touch-ups before you can actually use them:\n\n- data from the pump and the GCM sensor are basically two different datasets but kept in the same csv\n- while the time interval is 5 minutes (a reading from the GCM), not much else is going on otherwise\n- direct blood glucose measurements, insulin doses, etc. are delivered _whenever_ and not on-point of the 5min intervals\n\nHere I'll walk through the process of cleaning that up.\n\n# Reading the Raw Data\n\nFirst let's have a look at what we've got here. To save ourselves some headaches, I already put all the settings in all the places such that we get a nice tabular dataset. Most should be pretty self-explanatory: entries are delimited by a semicolon, the date format has to be sepcified and so on. I set `skip = 6` because, well, that's where the actual csv entries actually begin. Beforehand it's just some unstructured data about the device, patient, date of recordng, etc.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata_raw <- read_delim(\"data/sugr/carelink-export-220217.csv\", \n                  delim = \";\", escape_double = FALSE, \n                  col_types = cols(Date = col_date(format = \"%Y/%m/%d\"), \n                                   Time = col_time(format = \"%H:%M:%S\")), \n                  locale = locale(decimal_mark = \",\"), \n                  trim_ws = TRUE, skip = 6)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nNew names:\n• `` -> `...51`\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: One or more parsing issues, call `problems()` on your data frame for details,\ne.g.:\n  dat <- vroom(...)\n  problems(dat)\n```\n:::\n\n```{.r .cell-code}\nhead(data_raw)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 × 51\n  Index Date       Time     New Device…¹ BG So…² BG Re…³ Linke…⁴ Basal…⁵ Temp …⁶\n  <dbl> <date>     <time>   <lgl>        <chr>     <dbl> <chr>     <dbl> <lgl>  \n1     0 2022-02-17 11:07:38 NA           <NA>         NA <NA>      NA    NA     \n2     1 2022-02-17 11:02:39 NA           <NA>         NA <NA>      NA    NA     \n3     2 2022-02-17 11:00:00 NA           <NA>         NA <NA>       0.65 NA     \n4     3 2022-02-17 10:57:42 NA           <NA>         NA <NA>      NA    NA     \n5     4 2022-02-17 10:52:42 NA           <NA>         NA <NA>      NA    NA     \n6     5 2022-02-17 10:37:45 NA           <NA>         NA <NA>      NA    NA     \n# … with 42 more variables: `Temp Basal Type` <lgl>,\n#   `Temp Basal Duration (h:mm:ss)` <lgl>, `Bolus Type` <chr>,\n#   `Bolus Volume Selected (U)` <dbl>, `Bolus Volume Delivered (U)` <dbl>,\n#   `Bolus Duration (h:mm:ss)` <lgl>, `Prime Type` <chr>,\n#   `Prime Volume Delivered (U)` <dbl>, Alarm <chr>, Suspend <chr>,\n#   Rewind <lgl>, `BWZ Estimate (U)` <dbl>, `BWZ Target High BG (mg/dL)` <lgl>,\n#   `BWZ Target Low BG (mg/dL)` <lgl>, `BWZ Carb Ratio (g/U)` <dbl>, …\n```\n:::\n:::\n\n\nOkay, so, a **Warning**. What's that about?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nproblems(data_raw) %>% select(-file) %>% print(n = 120)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 112 × 4\n      row   col expected           actual                             \n    <int> <int> <chr>              <chr>                              \n  1   115    41 1/0/T/F/TRUE/FALSE 240                                \n  2   493    22 1/0/T/F/TRUE/FALSE 120                                \n  3   493    23 1/0/T/F/TRUE/FALSE 90                                 \n  4   493    25 1/0/T/F/TRUE/FALSE 40                                 \n  5   493    30 1/0/T/F/TRUE/FALSE 2,10                               \n  6   505    22 1/0/T/F/TRUE/FALSE 120                                \n  7   505    23 1/0/T/F/TRUE/FALSE 90                                 \n  8   505    25 1/0/T/F/TRUE/FALSE 40                                 \n  9   505    30 1/0/T/F/TRUE/FALSE 0,0                                \n 10   922    22 1/0/T/F/TRUE/FALSE 120                                \n 11   922    23 1/0/T/F/TRUE/FALSE 90                                 \n 12   922    25 1/0/T/F/TRUE/FALSE 40                                 \n 13   922    30 1/0/T/F/TRUE/FALSE 0,20                               \n 14   933    22 1/0/T/F/TRUE/FALSE 160                                \n 15   933    23 1/0/T/F/TRUE/FALSE 120                                \n 16   933    25 1/0/T/F/TRUE/FALSE 40                                 \n 17   933    30 1/0/T/F/TRUE/FALSE 4,20                               \n 18   937    22 1/0/T/F/TRUE/FALSE 160                                \n 19   937    23 1/0/T/F/TRUE/FALSE 120                                \n 20   937    25 1/0/T/F/TRUE/FALSE 40                                 \n 21   937    30 1/0/T/F/TRUE/FALSE 3,10                               \n 22   944    22 1/0/T/F/TRUE/FALSE 160                                \n 23   944    23 1/0/T/F/TRUE/FALSE 120                                \n 24   944    25 1/0/T/F/TRUE/FALSE 40                                 \n 25   944    30 1/0/T/F/TRUE/FALSE 2,40                               \n 26   955    22 1/0/T/F/TRUE/FALSE 120                                \n 27   955    23 1/0/T/F/TRUE/FALSE 90                                 \n 28   955    25 1/0/T/F/TRUE/FALSE 40                                 \n 29   955    30 1/0/T/F/TRUE/FALSE 0,20                               \n 30   981    48 1/0/T/F/TRUE/FALSE USER_INITIATED                     \n 31  1002    22 1/0/T/F/TRUE/FALSE 120                                \n 32  1002    23 1/0/T/F/TRUE/FALSE 90                                 \n 33  1002    25 1/0/T/F/TRUE/FALSE 40                                 \n 34  1002    30 1/0/T/F/TRUE/FALSE 0,0                                \n 35  1417    20 1/0/T/F/TRUE/FALSE Rewind                             \n 36  2715    22 1/0/T/F/TRUE/FALSE 120                                \n 37  2715    23 1/0/T/F/TRUE/FALSE 90                                 \n 38  2715    25 1/0/T/F/TRUE/FALSE 40                                 \n 39  2715    30 1/0/T/F/TRUE/FALSE 1,30                               \n 40  2726    22 1/0/T/F/TRUE/FALSE 120                                \n 41  2726    23 1/0/T/F/TRUE/FALSE 90                                 \n 42  2726    25 1/0/T/F/TRUE/FALSE 40                                 \n 43  2726    30 1/0/T/F/TRUE/FALSE 0,0                                \n 44  2746    22 1/0/T/F/TRUE/FALSE 140                                \n 45  2746    23 1/0/T/F/TRUE/FALSE 90                                 \n 46  2746    25 1/0/T/F/TRUE/FALSE 40                                 \n 47  2746    30 1/0/T/F/TRUE/FALSE 0,80                               \n 48  2760    22 1/0/T/F/TRUE/FALSE 120                                \n 49  2760    23 1/0/T/F/TRUE/FALSE 90                                 \n 50  2760    25 1/0/T/F/TRUE/FALSE 40                                 \n 51  2760    30 1/0/T/F/TRUE/FALSE 5,10                               \n 52  2762    22 1/0/T/F/TRUE/FALSE 120                                \n 53  2762    23 1/0/T/F/TRUE/FALSE 90                                 \n 54  2762    25 1/0/T/F/TRUE/FALSE 40                                 \n 55  2762    30 1/0/T/F/TRUE/FALSE 5,10                               \n 56  2768    22 1/0/T/F/TRUE/FALSE 140                                \n 57  2768    23 1/0/T/F/TRUE/FALSE 90                                 \n 58  2768    25 1/0/T/F/TRUE/FALSE 40                                 \n 59  2768    30 1/0/T/F/TRUE/FALSE 4,80                               \n 60  2772    22 1/0/T/F/TRUE/FALSE 140                                \n 61  2772    23 1/0/T/F/TRUE/FALSE 90                                 \n 62  2772    25 1/0/T/F/TRUE/FALSE 40                                 \n 63  2772    30 1/0/T/F/TRUE/FALSE 0,0                                \n 64  2779    48 1/0/T/F/TRUE/FALSE USER_INITIATED                     \n 65  2955    37 1/0/T/F/TRUE/FALSE User Request                       \n 66  3286    20 1/0/T/F/TRUE/FALSE Rewind                             \n 67  3321    37 1/0/T/F/TRUE/FALSE User Request                       \n 68  3806    37 1/0/T/F/TRUE/FALSE User Request                       \n 69  4338     1 a double           -------                            \n 70  4338     2 date like %Y/%m/%d MiniMed 670G MMT-1781              \n 71  4338     3 time like %H:%M:%S Sensor                             \n 72  4338     4 1/0/T/F/TRUE/FALSE NG2307024H                         \n 73  4338     5 51 columns         5 columns                          \n 74  4339     1 a double           Index                              \n 75  4339     2 date like %Y/%m/%d Date                               \n 76  4339     3 time like %H:%M:%S Time                               \n 77  4339     4 1/0/T/F/TRUE/FALSE New Device Time                    \n 78  4339     6 a double           BG Reading (mg/dL)                 \n 79  4339     8 a double           Basal Rate (U/h)                   \n 80  4339     9 1/0/T/F/TRUE/FALSE Temp Basal Amount                  \n 81  4339    10 1/0/T/F/TRUE/FALSE Temp Basal Type                    \n 82  4339    11 1/0/T/F/TRUE/FALSE Temp Basal Duration (h:mm:ss)      \n 83  4339    13 a double           Bolus Volume Selected (U)          \n 84  4339    14 a double           Bolus Volume Delivered (U)         \n 85  4339    15 1/0/T/F/TRUE/FALSE Bolus Duration (h:mm:ss)           \n 86  4339    17 a double           Prime Volume Delivered (U)         \n 87  4339    20 1/0/T/F/TRUE/FALSE Rewind                             \n 88  4339    21 a double           BWZ Estimate (U)                   \n 89  4339    22 1/0/T/F/TRUE/FALSE BWZ Target High BG (mg/dL)         \n 90  4339    23 1/0/T/F/TRUE/FALSE BWZ Target Low BG (mg/dL)          \n 91  4339    24 a double           BWZ Carb Ratio (g/U)               \n 92  4339    25 1/0/T/F/TRUE/FALSE BWZ Insulin Sensitivity (mg/dL/U)  \n 93  4339    26 a double           BWZ Carb Input (grams)             \n 94  4339    27 a double           BWZ BG Input (mg/dL)               \n 95  4339    28 a double           BWZ Correction Estimate (U)        \n 96  4339    29 a double           BWZ Food Estimate (U)              \n 97  4339    30 1/0/T/F/TRUE/FALSE BWZ Active Insulin (U)             \n 98  4339    32 a double           Sensor Calibration BG (mg/dL)      \n 99  4339    33 a double           Sensor Glucose (mg/dL)             \n100  4339    34 a double           ISIG Value                         \n101  4339    36 a double           Bolus Number                       \n102  4339    37 1/0/T/F/TRUE/FALSE Bolus Cancellation Reason          \n103  4339    38 a double           BWZ Unabsorbed Insulin Total (U)   \n104  4339    39 a double           Final Bolus Estimate               \n105  4339    41 1/0/T/F/TRUE/FALSE Insulin Action Curve Time          \n106  4339    42 1/0/T/F/TRUE/FALSE Sensor Calibration Rejected Reason \n107  4339    43 1/0/T/F/TRUE/FALSE Preset Bolus                       \n108  4339    45 1/0/T/F/TRUE/FALSE BLE Network Device                 \n109  4339    46 1/0/T/F/TRUE/FALSE Network Device Associated Reason   \n110  4339    47 1/0/T/F/TRUE/FALSE Network Device Disassociated Reason\n111  4339    48 1/0/T/F/TRUE/FALSE Network Device Disconnected Reason \n112  4339    50 1/0/T/F/TRUE/FALSE Preset Temp Basal Name             \n```\n:::\n:::\n\n\nAlright, the first ~70ish are actual parsing errors that lead to empty cells. Not great, but also no entries of huge importance^[mostly hard-coded things like ratios or target values that change slightly during a day but stay the same across all days], as far as I can tell. The rest though result from the circumstance that the file is basically seperated in CGM sensor data and insulin pump data, as mentioned in the beginning. Luckily though, `readr`/`vroom` just ignores the two rows where the new table begins - a device description and exactly same column names in the same order as before - and just continues parsing the CGM data. Let's take a look at those whopping 51 Variables:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(data_raw)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nRows: 9,236\nColumns: 51\n$ Index                                 <dbl> 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10…\n$ Date                                  <date> 2022-02-17, 2022-02-17, 2022-02…\n$ Time                                  <time> 11:07:38, 11:02:39, 11:00:00, 1…\n$ `New Device Time`                     <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `BG Source`                           <chr> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `BG Reading (mg/dL)`                  <dbl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Linked BG Meter ID`                  <chr> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Basal Rate (U/h)`                    <dbl> NA, NA, 0.65, NA, NA, NA, NA, NA…\n$ `Temp Basal Amount`                   <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Temp Basal Type`                     <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Temp Basal Duration (h:mm:ss)`       <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Bolus Type`                          <chr> \"Normal\", \"Normal\", NA, \"Normal\"…\n$ `Bolus Volume Selected (U)`           <dbl> 0.03, 0.05, NA, 0.05, 0.03, 0.03…\n$ `Bolus Volume Delivered (U)`          <dbl> 0.03, 0.05, NA, 0.05, 0.03, 0.03…\n$ `Bolus Duration (h:mm:ss)`            <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Prime Type`                          <chr> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Prime Volume Delivered (U)`          <dbl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ Alarm                                 <chr> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ Suspend                               <chr> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ Rewind                                <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `BWZ Estimate (U)`                    <dbl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `BWZ Target High BG (mg/dL)`          <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `BWZ Target Low BG (mg/dL)`           <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `BWZ Carb Ratio (g/U)`                <dbl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `BWZ Insulin Sensitivity (mg/dL/U)`   <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `BWZ Carb Input (grams)`              <dbl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `BWZ BG Input (mg/dL)`                <dbl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `BWZ Correction Estimate (U)`         <dbl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `BWZ Food Estimate (U)`               <dbl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `BWZ Active Insulin (U)`              <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `BWZ Status`                          <chr> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Sensor Calibration BG (mg/dL)`       <dbl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Sensor Glucose (mg/dL)`              <dbl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `ISIG Value`                          <dbl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Event Marker`                        <chr> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Bolus Number`                        <dbl> 236, 235, NA, 234, 233, 232, 231…\n$ `Bolus Cancellation Reason`           <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `BWZ Unabsorbed Insulin Total (U)`    <dbl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Final Bolus Estimate`                <dbl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Scroll Step Size`                    <chr> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Insulin Action Curve Time`           <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Sensor Calibration Rejected Reason`  <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Preset Bolus`                        <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Bolus Source`                        <chr> \"CLOSED_LOOP_MICRO_BOLUS\", \"CLOS…\n$ `BLE Network Device`                  <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Network Device Associated Reason`    <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Network Device Disassociated Reason` <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Network Device Disconnected Reason`  <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Sensor Exception`                    <chr> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ `Preset Temp Basal Name`              <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n$ ...51                                 <lgl> NA, NA, NA, NA, NA, NA, NA, NA, …\n```\n:::\n:::\n\n\nThat's a whole lotta `<NA>`s! Apart from that, it looks pretty decent already. Here's what needs to be done still:\n\n- throw out the variables we don't need (spoiler: most of them)\n- clean up the column names\n- `time` precision by minutes does absolutely suffice\n- a combined `datetime` column would be nice\n- a column of weekdays, too, just for some quality of life improvement\n\nIt also totally makes sense to split pump from CGM data, of course. Since both are structurally identical, we'll do that after the clean-up.\n\n# The Clean-up Procedure\n\nThere are basically three groups of variables:\n\n1. those of our main interest, like glucose measurements, insulin dosages, carbohydrate intake, etc\n2. some that might be of minor interest, but rather when it comes to device usage and diagnostics than actual medical interest, like alarms, suspension and rewind times, etc\n3. not interesting or useful at all\n\nFor now, we'll focus on the first type only.\n",
    "supporting": [
      "sugr-prep_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}