<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.555">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tobias">

<title>Tobias Anton - sugr: data preparation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Tobias Anton</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-cv" role="button" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">CV</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-cv">    
        <li>
    <a class="dropdown-item" href="../cv-ta-de.html">
 <span class="dropdown-text">Deutsch</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../cv-ta-en.html">
 <span class="dropdown-text">English</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../projects.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/marauderpixie"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://norden.social/@marauderpixie"> <i class="bi bi-mastodon" role="img" aria-label="Mastodon">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:tobanton@uni-osnabrueck.de"> <i class="bi bi-envelope-fill" role="img" aria-label="E-Mail">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">sugr: data preparation</h1>
            <p class="subtitle lead">Preparation of Continouos Glucose Measurements for usage in a shiny app</p>
                                <div class="quarto-categories">
                <div class="quarto-category">data cleaning</div>
                <div class="quarto-category">timeseries</div>
                <div class="quarto-category">medical</div>
                <div class="quarto-category">ETL</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Tobias </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Jul 22, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#abstract" id="toc-abstract" class="nav-link active" data-scroll-target="#abstract">Abstract</a></li>
  <li><a href="#reading-the-raw-data" id="toc-reading-the-raw-data" class="nav-link" data-scroll-target="#reading-the-raw-data">Reading the Raw Data</a></li>
  <li><a href="#the-clean-up-procedure" id="toc-the-clean-up-procedure" class="nav-link" data-scroll-target="#the-clean-up-procedure">The Clean-up Procedure</a>
  <ul class="collapse">
  <li><a href="#codebook" id="toc-codebook" class="nav-link" data-scroll-target="#codebook">Codebook</a></li>
  <li><a href="#cleaning-and-variable-selection" id="toc-cleaning-and-variable-selection" class="nav-link" data-scroll-target="#cleaning-and-variable-selection">Cleaning and Variable Selection</a></li>
  <li><a href="#section" id="toc-section" class="nav-link" data-scroll-target="#section"></a></li>
  <li><a href="#wrap-up" id="toc-wrap-up" class="nav-link" data-scroll-target="#wrap-up">Wrap-Up</a></li>
  </ul></li>
  <li><a href="#splitting-cgm-pump-data" id="toc-splitting-cgm-pump-data" class="nav-link" data-scroll-target="#splitting-cgm-pump-data">Splitting CGM &amp; Pump Data</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<div class="tldr">
<p><strong>tl;dr:</strong> CGMs are a great source of (timeseries) data to tinker with. Here I describe the process of cleaning up and preparing the data of Medtronics systems in order to use it in a shiny app.</p>
</div>
<section id="abstract" class="level1">
<h1>Abstract</h1>
<p>I’m a type I diabetic and therefore use an insulin pump and a connected CGM - continouos glucose measurement - system from Medtronic. The company kindly provides access to the raw data, even though only by the use of propriatory software and a web interface. This means I can’t access the data through some sort of API to automate the collection thereof and have to run through that process manually on a regular basis.</p>
<p>Apart from that minor nuisance what’s more important though is the fact that the data needs some touch-ups before you can actually use them:</p>
<ul>
<li>data from the pump and the GCM sensor are basically two different datasets but kept in the same csv</li>
<li>while the time interval is 5 minutes (a reading from the GCM), not much else is going on otherwise</li>
<li>direct blood glucose measurements, insulin doses, etc. are delivered <em>whenever</em> and not on-point of the 5min intervals</li>
</ul>
<p>Here I’ll walk through the process of cleaning that up.</p>
</section>
<section id="reading-the-raw-data" class="level1">
<h1>Reading the Raw Data</h1>
<p>First let’s have a look at what we’ve got here. To save ourselves some headaches, I already put all the settings in all the places such that we get a nice tabular dataset. Most should be pretty self-explanatory: entries are delimited by a semicolon, the date format has to be sepcified and so on. I set <code>skip = 6</code> because, well, that’s where the actual csv entries actually begin. Beforehand it’s just some unstructured data about the device, patient, date of recordng, etc.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Code</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Glimpse</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false">Warning</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>data_raw <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(<span class="st">"data/sugr/carelink-export-220217.csv"</span>, </span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">delim =</span> <span class="st">";"</span>, <span class="at">escape_double =</span> <span class="cn">FALSE</span>, </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">col_types =</span> <span class="fu">cols</span>(<span class="at">Date =</span> <span class="fu">col_date</span>(<span class="at">format =</span> <span class="st">"%Y/%m/%d"</span>), </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">Time =</span> <span class="fu">col_time</span>(<span class="at">format =</span> <span class="st">"%H:%M:%S"</span>)), </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">locale =</span> <span class="fu">locale</span>(<span class="at">decimal_mark =</span> <span class="st">","</span>), </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">trim_ws =</span> <span class="cn">TRUE</span>, <span class="at">skip =</span> <span class="dv">6</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
• `` -&gt; `...51`</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: One or more parsing issues, call `problems()` on your data frame for details,
e.g.:
  dat &lt;- vroom(...)
  problems(dat)</code></pre>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(data_raw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 9,236
Columns: 51
$ Index                                 &lt;dbl&gt; 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10…
$ Date                                  &lt;date&gt; 2022-02-17, 2022-02-17, 2022-02…
$ Time                                  &lt;time&gt; 11:07:38, 11:02:39, 11:00:00, 1…
$ `New Device Time`                     &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `BG Source`                           &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `BG Reading (mg/dL)`                  &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Linked BG Meter ID`                  &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Basal Rate (U/h)`                    &lt;dbl&gt; NA, NA, 0.65, NA, NA, NA, NA, NA…
$ `Temp Basal Amount`                   &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Temp Basal Type`                     &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Temp Basal Duration (h:mm:ss)`       &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Bolus Type`                          &lt;chr&gt; "Normal", "Normal", NA, "Normal"…
$ `Bolus Volume Selected (U)`           &lt;dbl&gt; 0.03, 0.05, NA, 0.05, 0.03, 0.03…
$ `Bolus Volume Delivered (U)`          &lt;dbl&gt; 0.03, 0.05, NA, 0.05, 0.03, 0.03…
$ `Bolus Duration (h:mm:ss)`            &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Prime Type`                          &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Prime Volume Delivered (U)`          &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ Alarm                                 &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ Suspend                               &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ Rewind                                &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `BWZ Estimate (U)`                    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `BWZ Target High BG (mg/dL)`          &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `BWZ Target Low BG (mg/dL)`           &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `BWZ Carb Ratio (g/U)`                &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `BWZ Insulin Sensitivity (mg/dL/U)`   &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `BWZ Carb Input (grams)`              &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `BWZ BG Input (mg/dL)`                &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `BWZ Correction Estimate (U)`         &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `BWZ Food Estimate (U)`               &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `BWZ Active Insulin (U)`              &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `BWZ Status`                          &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Sensor Calibration BG (mg/dL)`       &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Sensor Glucose (mg/dL)`              &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `ISIG Value`                          &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Event Marker`                        &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Bolus Number`                        &lt;dbl&gt; 236, 235, NA, 234, 233, 232, 231…
$ `Bolus Cancellation Reason`           &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `BWZ Unabsorbed Insulin Total (U)`    &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Final Bolus Estimate`                &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Scroll Step Size`                    &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Insulin Action Curve Time`           &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Sensor Calibration Rejected Reason`  &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Preset Bolus`                        &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Bolus Source`                        &lt;chr&gt; "CLOSED_LOOP_MICRO_BOLUS", "CLOS…
$ `BLE Network Device`                  &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Network Device Associated Reason`    &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Network Device Disassociated Reason` &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Network Device Disconnected Reason`  &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Sensor Exception`                    &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ `Preset Temp Basal Name`              &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …
$ ...51                                 &lt;lgl&gt; NA, NA, NA, NA, NA, NA, NA, NA, …</code></pre>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">problems</span>(data_raw) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>file) <span class="sc">%&gt;%</span> <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">120</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 112 × 4
      row   col expected           actual                             
    &lt;int&gt; &lt;int&gt; &lt;chr&gt;              &lt;chr&gt;                              
  1   115    41 1/0/T/F/TRUE/FALSE 240                                
  2   493    22 1/0/T/F/TRUE/FALSE 120                                
  3   493    23 1/0/T/F/TRUE/FALSE 90                                 
  4   493    25 1/0/T/F/TRUE/FALSE 40                                 
  5   493    30 1/0/T/F/TRUE/FALSE 2,10                               
  6   505    22 1/0/T/F/TRUE/FALSE 120                                
  7   505    23 1/0/T/F/TRUE/FALSE 90                                 
  8   505    25 1/0/T/F/TRUE/FALSE 40                                 
  9   505    30 1/0/T/F/TRUE/FALSE 0,0                                
 10   922    22 1/0/T/F/TRUE/FALSE 120                                
 11   922    23 1/0/T/F/TRUE/FALSE 90                                 
 12   922    25 1/0/T/F/TRUE/FALSE 40                                 
 13   922    30 1/0/T/F/TRUE/FALSE 0,20                               
 14   933    22 1/0/T/F/TRUE/FALSE 160                                
 15   933    23 1/0/T/F/TRUE/FALSE 120                                
 16   933    25 1/0/T/F/TRUE/FALSE 40                                 
 17   933    30 1/0/T/F/TRUE/FALSE 4,20                               
 18   937    22 1/0/T/F/TRUE/FALSE 160                                
 19   937    23 1/0/T/F/TRUE/FALSE 120                                
 20   937    25 1/0/T/F/TRUE/FALSE 40                                 
 21   937    30 1/0/T/F/TRUE/FALSE 3,10                               
 22   944    22 1/0/T/F/TRUE/FALSE 160                                
 23   944    23 1/0/T/F/TRUE/FALSE 120                                
 24   944    25 1/0/T/F/TRUE/FALSE 40                                 
 25   944    30 1/0/T/F/TRUE/FALSE 2,40                               
 26   955    22 1/0/T/F/TRUE/FALSE 120                                
 27   955    23 1/0/T/F/TRUE/FALSE 90                                 
 28   955    25 1/0/T/F/TRUE/FALSE 40                                 
 29   955    30 1/0/T/F/TRUE/FALSE 0,20                               
 30   981    48 1/0/T/F/TRUE/FALSE USER_INITIATED                     
 31  1002    22 1/0/T/F/TRUE/FALSE 120                                
 32  1002    23 1/0/T/F/TRUE/FALSE 90                                 
 33  1002    25 1/0/T/F/TRUE/FALSE 40                                 
 34  1002    30 1/0/T/F/TRUE/FALSE 0,0                                
 35  1417    20 1/0/T/F/TRUE/FALSE Rewind                             
 36  2715    22 1/0/T/F/TRUE/FALSE 120                                
 37  2715    23 1/0/T/F/TRUE/FALSE 90                                 
 38  2715    25 1/0/T/F/TRUE/FALSE 40                                 
 39  2715    30 1/0/T/F/TRUE/FALSE 1,30                               
 40  2726    22 1/0/T/F/TRUE/FALSE 120                                
 41  2726    23 1/0/T/F/TRUE/FALSE 90                                 
 42  2726    25 1/0/T/F/TRUE/FALSE 40                                 
 43  2726    30 1/0/T/F/TRUE/FALSE 0,0                                
 44  2746    22 1/0/T/F/TRUE/FALSE 140                                
 45  2746    23 1/0/T/F/TRUE/FALSE 90                                 
 46  2746    25 1/0/T/F/TRUE/FALSE 40                                 
 47  2746    30 1/0/T/F/TRUE/FALSE 0,80                               
 48  2760    22 1/0/T/F/TRUE/FALSE 120                                
 49  2760    23 1/0/T/F/TRUE/FALSE 90                                 
 50  2760    25 1/0/T/F/TRUE/FALSE 40                                 
 51  2760    30 1/0/T/F/TRUE/FALSE 5,10                               
 52  2762    22 1/0/T/F/TRUE/FALSE 120                                
 53  2762    23 1/0/T/F/TRUE/FALSE 90                                 
 54  2762    25 1/0/T/F/TRUE/FALSE 40                                 
 55  2762    30 1/0/T/F/TRUE/FALSE 5,10                               
 56  2768    22 1/0/T/F/TRUE/FALSE 140                                
 57  2768    23 1/0/T/F/TRUE/FALSE 90                                 
 58  2768    25 1/0/T/F/TRUE/FALSE 40                                 
 59  2768    30 1/0/T/F/TRUE/FALSE 4,80                               
 60  2772    22 1/0/T/F/TRUE/FALSE 140                                
 61  2772    23 1/0/T/F/TRUE/FALSE 90                                 
 62  2772    25 1/0/T/F/TRUE/FALSE 40                                 
 63  2772    30 1/0/T/F/TRUE/FALSE 0,0                                
 64  2779    48 1/0/T/F/TRUE/FALSE USER_INITIATED                     
 65  2955    37 1/0/T/F/TRUE/FALSE User Request                       
 66  3286    20 1/0/T/F/TRUE/FALSE Rewind                             
 67  3321    37 1/0/T/F/TRUE/FALSE User Request                       
 68  3806    37 1/0/T/F/TRUE/FALSE User Request                       
 69  4338     1 a double           -------                            
 70  4338     2 date like %Y/%m/%d MiniMed 670G MMT-1781              
 71  4338     3 time like %H:%M:%S Sensor                             
 72  4338     4 1/0/T/F/TRUE/FALSE NG2307024H                         
 73  4338     5 51 columns         5 columns                          
 74  4339     1 a double           Index                              
 75  4339     2 date like %Y/%m/%d Date                               
 76  4339     3 time like %H:%M:%S Time                               
 77  4339     4 1/0/T/F/TRUE/FALSE New Device Time                    
 78  4339     6 a double           BG Reading (mg/dL)                 
 79  4339     8 a double           Basal Rate (U/h)                   
 80  4339     9 1/0/T/F/TRUE/FALSE Temp Basal Amount                  
 81  4339    10 1/0/T/F/TRUE/FALSE Temp Basal Type                    
 82  4339    11 1/0/T/F/TRUE/FALSE Temp Basal Duration (h:mm:ss)      
 83  4339    13 a double           Bolus Volume Selected (U)          
 84  4339    14 a double           Bolus Volume Delivered (U)         
 85  4339    15 1/0/T/F/TRUE/FALSE Bolus Duration (h:mm:ss)           
 86  4339    17 a double           Prime Volume Delivered (U)         
 87  4339    20 1/0/T/F/TRUE/FALSE Rewind                             
 88  4339    21 a double           BWZ Estimate (U)                   
 89  4339    22 1/0/T/F/TRUE/FALSE BWZ Target High BG (mg/dL)         
 90  4339    23 1/0/T/F/TRUE/FALSE BWZ Target Low BG (mg/dL)          
 91  4339    24 a double           BWZ Carb Ratio (g/U)               
 92  4339    25 1/0/T/F/TRUE/FALSE BWZ Insulin Sensitivity (mg/dL/U)  
 93  4339    26 a double           BWZ Carb Input (grams)             
 94  4339    27 a double           BWZ BG Input (mg/dL)               
 95  4339    28 a double           BWZ Correction Estimate (U)        
 96  4339    29 a double           BWZ Food Estimate (U)              
 97  4339    30 1/0/T/F/TRUE/FALSE BWZ Active Insulin (U)             
 98  4339    32 a double           Sensor Calibration BG (mg/dL)      
 99  4339    33 a double           Sensor Glucose (mg/dL)             
100  4339    34 a double           ISIG Value                         
101  4339    36 a double           Bolus Number                       
102  4339    37 1/0/T/F/TRUE/FALSE Bolus Cancellation Reason          
103  4339    38 a double           BWZ Unabsorbed Insulin Total (U)   
104  4339    39 a double           Final Bolus Estimate               
105  4339    41 1/0/T/F/TRUE/FALSE Insulin Action Curve Time          
106  4339    42 1/0/T/F/TRUE/FALSE Sensor Calibration Rejected Reason 
107  4339    43 1/0/T/F/TRUE/FALSE Preset Bolus                       
108  4339    45 1/0/T/F/TRUE/FALSE BLE Network Device                 
109  4339    46 1/0/T/F/TRUE/FALSE Network Device Associated Reason   
110  4339    47 1/0/T/F/TRUE/FALSE Network Device Disassociated Reason
111  4339    48 1/0/T/F/TRUE/FALSE Network Device Disconnected Reason 
112  4339    50 1/0/T/F/TRUE/FALSE Preset Temp Basal Name             </code></pre>
</div>
</div>
</div>
</div>
</div>
<p>Okay, so, a <strong>Warning</strong>. What’s that about?</p>
<p>Alright, the first ~70ish are actual parsing errors that lead to empty cells. Not great, but also no entries of huge importance<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, as far as I can tell. The rest though result from the circumstance that the file is basically seperated in CGM sensor data and insulin pump data, as mentioned in the beginning. Luckily though, <code>readr</code>/<code>vroom</code> just ignores the two rows where the new table begins - a device description and exactly same column names in the same order as before - and just continues parsing the CGM data. Let’s take a look at those whopping 51 Variables:</p>
<p>Looks pretty decent already. That’s a whole lotta <code>&lt;NA&gt;</code>s, though. We’ll have to look into that in another article.</p>
</section>
<section id="the-clean-up-procedure" class="level1">
<h1>The Clean-up Procedure</h1>
<p>Here’s what needs to be done still:</p>
<ul>
<li>clean up the column names</li>
<li>throw out the variables we don’t need (spoiler: most of them)</li>
<li><code>time</code> precision by minutes should suffice</li>
<li>a combined <code>datetime</code> column would be nice</li>
<li>a column of weekdays, too, just for some quality of life improvement</li>
</ul>
<p>It also totally makes sense to split pump from CGM data, of course. Since both are structurally identical, though, we’ll do that after the clean-up. At this point, we’re also only interested in variables that directly deal with glucose measurements, insulin dosage and carbohydrate intake<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
<section id="codebook" class="level2">
<h2 class="anchored" data-anchor-id="codebook">Codebook</h2>
<p>The variables of interest are:</p>
<div class="fullwidth">
<table class="caption-top table">
<colgroup>
<col style="width: 13%">
<col style="width: 17%">
<col style="width: 69%">
</colgroup>
<thead>
<tr class="header">
<th>Variable</th>
<th>Renamed to</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>Index</code></td>
<td><code>index</code></td>
<td>kinda self-explanatory</td>
</tr>
<tr class="even">
<td><code>Date</code></td>
<td><code>date</code></td>
<td>Year-Month-Day</td>
</tr>
<tr class="odd">
<td><code>Time</code></td>
<td><code>time</code></td>
<td>hh:mm:ss</td>
</tr>
<tr class="even">
<td><code>BG Reading (mg/dL)</code></td>
<td><code>bg_direct</code></td>
<td>a <strong>direct</strong> measurement of blood, usually by pricking a finger</td>
</tr>
<tr class="odd">
<td><code>Sensor Glucose (mg/dL)</code></td>
<td><code>bg_sensor</code></td>
<td>an <em>indirect</em> measurement of interstitial fluid by the gcm sensor</td>
</tr>
<tr class="even">
<td><code>Basal Rate (U/h)</code></td>
<td><code>basal_rate</code></td>
<td>the hourly rate of insulin given (in ‘Units’; roughly 100U/ml)</td>
</tr>
<tr class="odd">
<td><code>BWZ BG Input (mg/dL)</code></td>
<td><code>wiz_bg</code></td>
<td>blood glucose level (manual input)</td>
</tr>
<tr class="even">
<td><code>BWZ Carb Input (grams)</code></td>
<td><code>wiz_carbs</code></td>
<td>carbohydrates (manual input)</td>
</tr>
<tr class="odd">
<td><code>BWZ Carb Ratio (g/U)</code></td>
<td><code>wiz_ratio</code></td>
<td>ratio of carbs per unit of insulin</td>
</tr>
<tr class="even">
<td><code>BWZ Correction Estimate (U)</code></td>
<td><code>wiz_est_correction</code></td>
<td>insulin to deliver to correct for too high bg level</td>
</tr>
<tr class="odd">
<td><code>BWZ Food Estimate (U)</code></td>
<td><code>wiz_est_food</code></td>
<td>insulin units to deliver for the amount of carbohydrates (carbs / ratio)</td>
</tr>
<tr class="even">
<td><code>BWZ Unabsorbed Insulin Total (U)</code></td>
<td><code>wiz_est_unabsorbed</code></td>
<td>insulin to <em>not</em> deliver in order to not overcompensate</td>
</tr>
<tr class="odd">
<td><code>Final Bolus Estimate</code></td>
<td><code>bolus_final</code></td>
<td>amount of insulin to deliver</td>
</tr>
<tr class="even">
<td><code>Bolus Volume Delivered (U)</code></td>
<td><code>bolus_delivered</code></td>
<td>the actual amount of insulin delivered</td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="cleaning-and-variable-selection" class="level2">
<h2 class="anchored" data-anchor-id="cleaning-and-variable-selection">Cleaning and Variable Selection</h2>
<p>To clean up column names, we could of course use some convenient helper function like <code>clean_names()</code> from the <code>janitor</code> package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>janitor<span class="sc">::</span><span class="fu">clean_names</span>(data_raw) <span class="sc">%&gt;%</span> <span class="fu">names</span>() <span class="sc">%&gt;%</span> <span class="fu">sort</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "alarm"                               "basal_rate_u_h"                     
 [3] "bg_reading_mg_d_l"                   "bg_source"                          
 [5] "ble_network_device"                  "bolus_cancellation_reason"          
 [7] "bolus_duration_h_mm_ss"              "bolus_number"                       
 [9] "bolus_source"                        "bolus_type"                         
[11] "bolus_volume_delivered_u"            "bolus_volume_selected_u"            
[13] "bwz_active_insulin_u"                "bwz_bg_input_mg_d_l"                
[15] "bwz_carb_input_grams"                "bwz_carb_ratio_g_u"                 
[17] "bwz_correction_estimate_u"           "bwz_estimate_u"                     
[19] "bwz_food_estimate_u"                 "bwz_insulin_sensitivity_mg_d_l_u"   
[21] "bwz_status"                          "bwz_target_high_bg_mg_d_l"          
[23] "bwz_target_low_bg_mg_d_l"            "bwz_unabsorbed_insulin_total_u"     
[25] "date"                                "event_marker"                       
[27] "final_bolus_estimate"                "index"                              
[29] "insulin_action_curve_time"           "isig_value"                         
[31] "linked_bg_meter_id"                  "network_device_associated_reason"   
[33] "network_device_disassociated_reason" "network_device_disconnected_reason" 
[35] "new_device_time"                     "preset_bolus"                       
[37] "preset_temp_basal_name"              "prime_type"                         
[39] "prime_volume_delivered_u"            "rewind"                             
[41] "scroll_step_size"                    "sensor_calibration_bg_mg_d_l"       
[43] "sensor_calibration_rejected_reason"  "sensor_exception"                   
[45] "sensor_glucose_mg_d_l"               "suspend"                            
[47] "temp_basal_amount"                   "temp_basal_duration_h_mm_ss"        
[49] "temp_basal_type"                     "time"                               
[51] "x51"                                </code></pre>
</div>
</div>
<p>As you can see, that does indeed make them “workable”, but it’s still pretty convoluted and even occasionally confusing. Therefore, in a second step, we do some touch-ups manually and get rid of all the columns we’re not interested in. And since we’re already at it, why not tick off the rest of the items on our list, too?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>data_full <span class="ot">&lt;-</span> data_raw <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">index =</span> index,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">datetime =</span> <span class="fu">round_date</span>(<span class="fu">ymd_hms</span>(<span class="fu">paste</span>(date, time)), <span class="at">unit =</span> <span class="st">"minute"</span>),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">date  =</span> date,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">wday  =</span> <span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">week_start =</span> <span class="dv">1</span>),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">time  =</span> time,</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">basal_rate =</span> basal_rate_u_h,</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">bg_direct  =</span> bg_reading_mg_d_l,</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">bg_sensor  =</span> sensor_glucose_mg_d_l,</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">wiz_ratio =</span> bwz_carb_ratio_g_u,</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">wiz_carbs =</span> bwz_carb_input_grams,</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">wiz_bg =</span> bwz_bg_input_mg_d_l,</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">wiz_est_correction =</span> bwz_correction_estimate_u,</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">wiz_est_food =</span> bwz_food_estimate_u,</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">wiz_est_unabsorbed =</span> bwz_unabsorbed_insulin_total_u,</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">bolus_final =</span> final_bolus_estimate, </span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">bolus_delivered =</span> bolus_volume_delivered_u</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: There was 1 warning in `transmute()`.
ℹ In argument: `datetime = round_date(ymd_hms(paste(date, time)), unit =
  "minute")`.
Caused by warning:
!  2 failed to parse.</code></pre>
</div>
</div>
</section>
<section id="section" class="level2">
<h2 class="anchored" data-anchor-id="section"></h2>
<p>Another <strong>Warning</strong>, this time a parsing failure? Most certainly either when calling for the weekday labels or concoctenating and rounding the datetime:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anyNA</span>(data_full<span class="sc">$</span>wday)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>data_full <span class="sc">%&gt;%</span> </span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(wday)) <span class="sc">%&gt;%</span> </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 2
Columns: 16
$ index              &lt;dbl&gt; NA, NA
$ datetime           &lt;dttm&gt; NA, NA
$ date               &lt;date&gt; NA, NA
$ wday               &lt;ord&gt; NA, NA
$ time               &lt;time&gt; NA, NA
$ basal_rate         &lt;dbl&gt; NA, NA
$ bg_direct          &lt;dbl&gt; NA, NA
$ bg_sensor          &lt;dbl&gt; NA, NA
$ wiz_ratio          &lt;dbl&gt; NA, NA
$ wiz_carbs          &lt;dbl&gt; NA, NA
$ wiz_bg             &lt;dbl&gt; NA, NA
$ wiz_est_correction &lt;dbl&gt; NA, NA
$ wiz_est_food       &lt;dbl&gt; NA, NA
$ wiz_est_unabsorbed &lt;dbl&gt; NA, NA
$ bolus_final        &lt;dbl&gt; NA, NA
$ bolus_delivered    &lt;dbl&gt; NA, NA</code></pre>
</div>
</div>
<p>Two completely empty rows alright. Since even the <code>index</code> column is empty, it’s probably just an artefact of the “two datasets in one file issue”. We better check that out, too, though.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Find Suspects</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Glimpse</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anyNA</span>(data_raw<span class="sc">$</span>Index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">which</span>(<span class="fu">is.na</span>(data_raw<span class="sc">$</span>Index))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4337 4338</code></pre>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>data_raw[<span class="dv">4336</span><span class="sc">:</span><span class="dv">4339</span>, ] <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">glimpse</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 4
Columns: 51
$ Index                                 &lt;dbl&gt; 4335, NA, NA, 4336
$ Date                                  &lt;date&gt; 2022-01-30, NA, NA, 2022-02-17
$ Time                                  &lt;time&gt; 23:50:04,       NA,       NA, 11…
$ `New Device Time`                     &lt;lgl&gt; NA, NA, NA, NA
$ `BG Source`                           &lt;chr&gt; NA, "-------", "BG Source", NA
$ `BG Reading (mg/dL)`                  &lt;dbl&gt; NA, NA, NA, NA
$ `Linked BG Meter ID`                  &lt;chr&gt; NA, NA, "Linked BG Meter ID", NA
$ `Basal Rate (U/h)`                    &lt;dbl&gt; NA, NA, NA, NA
$ `Temp Basal Amount`                   &lt;lgl&gt; NA, NA, NA, NA
$ `Temp Basal Type`                     &lt;lgl&gt; NA, NA, NA, NA
$ `Temp Basal Duration (h:mm:ss)`       &lt;lgl&gt; NA, NA, NA, NA
$ `Bolus Type`                          &lt;chr&gt; NA, NA, "Bolus Type", NA
$ `Bolus Volume Selected (U)`           &lt;dbl&gt; NA, NA, NA, NA
$ `Bolus Volume Delivered (U)`          &lt;dbl&gt; NA, NA, NA, NA
$ `Bolus Duration (h:mm:ss)`            &lt;lgl&gt; NA, NA, NA, NA
$ `Prime Type`                          &lt;chr&gt; NA, NA, "Prime Type", NA
$ `Prime Volume Delivered (U)`          &lt;dbl&gt; NA, NA, NA, NA
$ Alarm                                 &lt;chr&gt; NA, NA, "Alarm", NA
$ Suspend                               &lt;chr&gt; NA, NA, "Suspend", NA
$ Rewind                                &lt;lgl&gt; NA, NA, NA, NA
$ `BWZ Estimate (U)`                    &lt;dbl&gt; NA, NA, NA, NA
$ `BWZ Target High BG (mg/dL)`          &lt;lgl&gt; NA, NA, NA, NA
$ `BWZ Target Low BG (mg/dL)`           &lt;lgl&gt; NA, NA, NA, NA
$ `BWZ Carb Ratio (g/U)`                &lt;dbl&gt; NA, NA, NA, NA
$ `BWZ Insulin Sensitivity (mg/dL/U)`   &lt;lgl&gt; NA, NA, NA, NA
$ `BWZ Carb Input (grams)`              &lt;dbl&gt; NA, NA, NA, NA
$ `BWZ BG Input (mg/dL)`                &lt;dbl&gt; NA, NA, NA, NA
$ `BWZ Correction Estimate (U)`         &lt;dbl&gt; NA, NA, NA, NA
$ `BWZ Food Estimate (U)`               &lt;dbl&gt; NA, NA, NA, NA
$ `BWZ Active Insulin (U)`              &lt;lgl&gt; NA, NA, NA, NA
$ `BWZ Status`                          &lt;chr&gt; NA, NA, "BWZ Status", NA
$ `Sensor Calibration BG (mg/dL)`       &lt;dbl&gt; NA, NA, NA, NA
$ `Sensor Glucose (mg/dL)`              &lt;dbl&gt; NA, NA, NA, 122
$ `ISIG Value`                          &lt;dbl&gt; NA, NA, NA, 23.9
$ `Event Marker`                        &lt;chr&gt; NA, NA, "Event Marker", NA
$ `Bolus Number`                        &lt;dbl&gt; NA, NA, NA, NA
$ `Bolus Cancellation Reason`           &lt;lgl&gt; NA, NA, NA, NA
$ `BWZ Unabsorbed Insulin Total (U)`    &lt;dbl&gt; NA, NA, NA, NA
$ `Final Bolus Estimate`                &lt;dbl&gt; NA, NA, NA, NA
$ `Scroll Step Size`                    &lt;chr&gt; NA, NA, "Scroll Step Size", NA
$ `Insulin Action Curve Time`           &lt;lgl&gt; NA, NA, NA, NA
$ `Sensor Calibration Rejected Reason`  &lt;lgl&gt; NA, NA, NA, NA
$ `Preset Bolus`                        &lt;lgl&gt; NA, NA, NA, NA
$ `Bolus Source`                        &lt;chr&gt; NA, NA, "Bolus Source", NA
$ `BLE Network Device`                  &lt;lgl&gt; NA, NA, NA, NA
$ `Network Device Associated Reason`    &lt;lgl&gt; NA, NA, NA, NA
$ `Network Device Disassociated Reason` &lt;lgl&gt; NA, NA, NA, NA
$ `Network Device Disconnected Reason`  &lt;lgl&gt; NA, NA, NA, NA
$ `Sensor Exception`                    &lt;chr&gt; NA, NA, "Sensor Exception", NA
$ `Preset Temp Basal Name`              &lt;lgl&gt; NA, NA, NA, NA
$ ...51                                 &lt;lgl&gt; NA, NA, NA, NA</code></pre>
</div>
</div>
</div>
</div>
</div>
<p>That confirms it. Actually, we should throw those lines out right at the beginning of the process.</p>
</section>
<section id="wrap-up" class="level2">
<h2 class="anchored" data-anchor-id="wrap-up">Wrap-Up</h2>
<p>Doing it all in one go might then look like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>data_full <span class="ot">&lt;-</span> <span class="fu">read_delim</span>(<span class="st">"data/sugr/carelink-export-220217.csv"</span>, </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">delim =</span> <span class="st">";"</span>, <span class="at">escape_double =</span> <span class="cn">FALSE</span>, </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">col_types =</span> <span class="fu">cols</span>(<span class="at">Date =</span> <span class="fu">col_date</span>(<span class="at">format =</span> <span class="st">"%Y/%m/%d"</span>), </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">Time =</span> <span class="fu">col_time</span>(<span class="at">format =</span> <span class="st">"%H:%M:%S"</span>)), </span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">locale =</span> <span class="fu">locale</span>(<span class="at">decimal_mark =</span> <span class="st">","</span>), </span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">trim_ws =</span> <span class="cn">TRUE</span>, <span class="at">skip =</span> <span class="dv">6</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  janitor<span class="sc">::</span><span class="fu">clean_names</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(index)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">transmute</span>(</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">index              =</span> index,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">datetime_rounded   =</span> <span class="fu">round_date</span>(<span class="fu">ymd_hms</span>(<span class="fu">paste</span>(date, time)), <span class="at">unit =</span> <span class="st">"minute"</span>),</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">datetime           =</span> <span class="fu">ymd_hms</span>(<span class="fu">paste</span>(date, time)),</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">date               =</span> date,</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">wday               =</span> <span class="fu">wday</span>(date, <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">week_start =</span> <span class="dv">1</span>),</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">time               =</span> time,</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">basal_rate         =</span> basal_rate_u_h,</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">bg_direct          =</span> bg_reading_mg_d_l,</span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">bg_sensor          =</span> sensor_glucose_mg_d_l,</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">wiz_ratio          =</span> bwz_carb_ratio_g_u,</span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">wiz_carbs          =</span> bwz_carb_input_grams,</span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">wiz_bg             =</span> bwz_bg_input_mg_d_l,</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">wiz_est_correction =</span> bwz_correction_estimate_u,</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">wiz_est_food       =</span> bwz_food_estimate_u,</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">wiz_est_unabsorbed =</span> bwz_unabsorbed_insulin_total_u,</span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">bolus_final        =</span> final_bolus_estimate, </span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">bolus_delivered    =</span> bolus_volume_delivered_u</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="splitting-cgm-pump-data" class="level1 page-columns page-full">
<h1>Splitting CGM &amp; Pump Data</h1>
<p>Now that the whole thing is cleaned up the only thing left to do is splitting pump and sensor data into seperate dataframes. We could of course leave it as is, but a split brings some advantages. The CGM is not in sync with the (semi-manual) pump data; while the former happens very much exactly every 5 minutes<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>, the latter just happens whenever. Additionally, at the initial reading of the data we already noticed the - professionally speaking - sheer insane amount of <code>NA</code>s, which we can drastically reduced by the split. When we color every cell of the data by whether it contains a value or not, it looks like this:</p>
<div class="cell page-columns page-full">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>data_full <span class="sc">%&gt;%</span> </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map_df</span>(is.na) <span class="sc">%&gt;%</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">map_df</span>(<span class="cf">function</span>(.){<span class="fu">ifelse</span>(., <span class="st">"&lt;NA&gt;"</span>, <span class="st">"not &lt;NA&gt;"</span>)}) <span class="sc">%&gt;%</span> </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">row_num =</span> <span class="fu">length</span>(index) <span class="sc">-</span> <span class="fu">seq_along</span>(index)) <span class="sc">%&gt;%</span> </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>row_num,</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"col"</span>, </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_transform =</span> as_factor,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"na"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(col, row_num, <span class="at">fill =</span> na)) <span class="sc">+</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="at">height =</span> .<span class="dv">95</span>, <span class="at">width =</span> .<span class="dv">95</span>, <span class="at">alpha =</span> .<span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#ff3300"</span>,<span class="st">"#00cc00"</span>)) <span class="sc">+</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>,</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.x  =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.y  =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in grid.Call(C_stringMetric, as.graphicsAnnot(x$label)):
Zeichensatzfamilie in der Windows Zeichensatzdatenbank nicht gefunden</code></pre>
</div>
<div class="cell-output-display page-columns page-full">
<div class="page-columns page-full">
<figure class="figure page-columns page-full">
<p class="page-columns page-full"><img src="sugr-prep_files/figure-html/b3_viz_na-1.png" class="img-fluid figure-img column-body" width="960"></p>
</figure>
</div>
</div>
</div>
<p>That’s a lot of unused tabular real estate, what a waste… We can clearly see where pump data ends and CGM data begins, though. The ‘green block’ on the left hand side naturally consists of the timedate and indexing columns. We can also see that there are still otherwise empty rows in the lower part (the CGM data). There are two approaches by which to split the thing: (1) simply <code>filter</code> the <code>bg_sensor</code> column by checking for <code>NA</code> values and conveniently drop the empty CGM rows, too, or (2) use the previously identified index-row, such that those empty rows are kept and can be used to further investigate whats going on there<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>. For the sake of thoroughness, let’s go with Option 2, have a look at what’s going on there and possibly remove those empty rows later.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>cutoff_idx <span class="ot">&lt;-</span> data_full<span class="sc">$</span>index[<span class="fu">min</span>(<span class="fu">which</span>(<span class="sc">!</span><span class="fu">is.na</span>(data_full<span class="sc">$</span>bg_sensor)))]</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>cgm <span class="ot">&lt;-</span> data_full <span class="sc">%&gt;%</span> </span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(index <span class="sc">&gt;</span> cutoff_idx) <span class="sc">%&gt;%</span> </span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(index, datetime, date, wday, time, bg_sensor)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>pump <span class="ot">&lt;-</span> data_full <span class="sc">%&gt;%</span> </span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(index <span class="sc">&lt;=</span> cutoff_idx) <span class="sc">%&gt;%</span> </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>bg_sensor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>cgm <span class="sc">%&gt;%</span> </span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_df</span>(is.na) <span class="sc">%&gt;%</span> </span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_df</span>(<span class="cf">function</span>(.){<span class="fu">ifelse</span>(., <span class="st">"&lt;NA&gt;"</span>, <span class="st">"not &lt;NA&gt;"</span>)}) <span class="sc">%&gt;%</span> </span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">row_num =</span> <span class="fu">length</span>(index) <span class="sc">-</span> <span class="fu">seq_along</span>(index)) <span class="sc">%&gt;%</span> </span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>row_num,</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"col"</span>, </span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_transform =</span> as_factor,</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"na"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(col, row_num, <span class="at">fill =</span> na)) <span class="sc">+</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="at">height =</span> .<span class="dv">95</span>, <span class="at">width =</span> .<span class="dv">95</span>, <span class="at">alpha =</span> .<span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#ff3300"</span>,<span class="st">"#00cc00"</span>)) <span class="sc">+</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.x  =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.y  =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>())</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>pump <span class="sc">%&gt;%</span> </span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_df</span>(is.na) <span class="sc">%&gt;%</span> </span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_df</span>(<span class="cf">function</span>(.){<span class="fu">ifelse</span>(., <span class="st">"&lt;NA&gt;"</span>, <span class="st">"not &lt;NA&gt;"</span>)}) <span class="sc">%&gt;%</span> </span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">row_num =</span> <span class="fu">length</span>(index) <span class="sc">-</span> <span class="fu">seq_along</span>(index)) <span class="sc">%&gt;%</span> </span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>row_num,</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_to =</span> <span class="st">"col"</span>, </span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>                 <span class="at">names_transform =</span> as_factor,</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>                 <span class="at">values_to =</span> <span class="st">"na"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(col, row_num, <span class="at">fill =</span> na)) <span class="sc">+</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_tile</span>(<span class="at">height =</span> .<span class="dv">95</span>, <span class="at">width =</span> .<span class="dv">95</span>, <span class="at">alpha =</span> .<span class="dv">8</span>) <span class="sc">+</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#ff3300"</span>,<span class="st">"#00cc00"</span>)) <span class="sc">+</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"none"</span>,</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.x  =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text.y  =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.title.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.title.y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.major =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>          <span class="at">panel.grid.minor =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="sugr-prep_files/figure-html/b3_split_plot-1.png" class="img-fluid figure-img" width="960"></p>
<figcaption>CGM Data</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="sugr-prep_files/figure-html/b3_split_plot-2.png" class="img-fluid figure-img" width="960"></p>
<figcaption>Pump Data</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>Well, better. There’s still room for improvement, especially regarding the pump data: Lots of small bolus deliveries (the last column) not accompanied by any other action, which we could further split up, for example. Doing so is mainly a matter of iterating on the steps we’ve taken so far and at this point we’re already in a good position from which we one can start further exploration and analysis of the data. The initial clean- and split-up procedure can therefore be considered concluded. Cheers!</p>
<!-- 

::: {.cell}

```{.r .cell-code}
wiz <- pump %>% 
  select(-bolus_delivered) %>% 
  filter(!if_all(basal_rate:bolus_final, is.na))

bolus <- pump %>% 
  select(index:time, bolus_delivered) %>% 
  filter(!is.na(bolus_delivered))
```
:::

::: {.cell layout-ncol="2"}

```{.r .cell-code  code-fold="true"}
wiz %>% 
  map_df(is.na) %>% 
  map_df(function(.){ifelse(., "<NA>", "not <NA>")}) %>% 
    mutate(row_num = length(index) - seq_along(index)) %>% 
    pivot_longer(cols = -row_num,
                 names_to = "col", 
                 names_transform = as_factor,
                 values_to = "na") %>% 
  ggplot(aes(col, row_num, fill = na)) +
    geom_tile(height = .95, width = .95, alpha = .8) +
    scale_fill_manual(values = c("#ff3300","#00cc00")) +
    theme(legend.position = "none",
          legend.title = element_blank(),
          axis.text.x  = element_blank(),
          axis.text.y  = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
```

::: {.cell-output-display}
![Wizard Data](sugr-prep_files/figure-html/b3_splitterer_plot-1.png){width=960}
:::

```{.r .cell-code  code-fold="true"}
bolus %>% 
  map_df(is.na) %>% 
  map_df(function(.){ifelse(., "<NA>", "not <NA>")}) %>% 
    mutate(row_num = length(index) - seq_along(index)) %>% 
    pivot_longer(cols = -row_num,
                 names_to = "col", 
                 names_transform = as_factor,
                 values_to = "na") %>% 
  ggplot(aes(col, row_num, fill = na)) +
    geom_tile(height = .95, width = .95, alpha = .8) +
    scale_fill_manual(values = c("#00cc00", "#ff3300")) +
    theme(legend.position = "none",
          legend.title = element_blank(),
          axis.text.x  = element_blank(),
          axis.text.y  = element_blank(),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank())
```

::: {.cell-output-display}
![Bolus Delivery Data](sugr-prep_files/figure-html/b3_splitterer_plot-2.png){width=960}
:::
:::

-->


</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>mostly hard-coded things like ratios or target values that change slightly during a day but stay the same across all days<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>other variables contain aforementioned “hard codings” or diagnostics on device usage such as low battery warnings<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>with an unspecific shift happening once a week whenever the sensor has to be replaced<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>Actually, a third possibility is the extraction of only those empty rows within the CGM block, but losing the context in which they appear is not very practical.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = true;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/tobiasanton\.eu");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
<p>— All Rites Reversed. Beware of Sleestak! —</p>
</div>
    <div class="nav-footer-right">
      &nbsp;
    </div>
  </div>
</footer>




<script src="../site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>